\doxysection{train.\+py}
\hypertarget{train_8py_source}{}\label{train_8py_source}\index{physaug/vqvae/train.py@{physaug/vqvae/train.py}}
\mbox{\hyperlink{train_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00001}\mbox{\hyperlink{namespacetrain}{00001}}\ \textcolor{keyword}{import}\ torch}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00002}00002\ \textcolor{keyword}{from}\ torch.utils.data\ \textcolor{keyword}{import}\ DataLoader}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00003}00003\ \textcolor{keyword}{from}\ torchvision\ \textcolor{keyword}{import}\ transforms,\ datasets}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00004}00004\ \textcolor{keyword}{from}\ .vqvae\ \textcolor{keyword}{import}\ VQVAE}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00005}00005\ \textcolor{keyword}{from}\ physaug.utils.logger\ \textcolor{keyword}{import}\ setup\_logger}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00006}00006\ \textcolor{keyword}{from}\ physaug.utils.io\ \textcolor{keyword}{import}\ save\_image}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{train_8py_source_l00008}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer}{00008}}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer}{VQVAETrainer}}:}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00009}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a3a3d29424c3c09440e1fbc73064e6efe}{00009}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a3a3d29424c3c09440e1fbc73064e6efe}{\_\_init\_\_}}(self,\ config):}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00010}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ab9bfe46d0164b13fa4c1fe01df98936f}{00010}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ab9bfe46d0164b13fa4c1fe01df98936f}{cfg}}\ =\ config}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00011}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aae385d47fb914216902363ee452d30db}{00011}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aae385d47fb914216902363ee452d30db}{device}}\ =\ \textcolor{stringliteral}{"{}cuda"{}}\ \textcolor{keywordflow}{if}\ torch.cuda.is\_available()\ \textcolor{keywordflow}{else}\ \textcolor{stringliteral}{"{}cpu"{}}}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00012}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ae0b075546c18498b87aa092e22a0ed3b}{00012}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ae0b075546c18498b87aa092e22a0ed3b}{logger}}\ =\ setup\_logger(\textcolor{stringliteral}{"{}vqvae\_trainer"{}},\ config[\textcolor{stringliteral}{"{}log\_dir"{}}])}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00013}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aa9b70ab17914958358dd95948b30eb3c}{00013}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aa9b70ab17914958358dd95948b30eb3c}{model}}\ =\ \mbox{\hyperlink{classvqvae_1_1_v_q_v_a_e}{VQVAE}}().to(self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aae385d47fb914216902363ee452d30db}{device}})}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00014}00014\ \ \ \ \ \ \ \ \ lr\ =\ float(config[\textcolor{stringliteral}{"{}vqvae"{}}][\textcolor{stringliteral}{"{}learning\_rate"{}}])\ \ \textcolor{comment}{\#\ Convert\ string\ to\ float}}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00015}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a2027952a103bbc6f53d22f443a1d381c}{00015}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a2027952a103bbc6f53d22f443a1d381c}{optimizer}}\ =\ torch.optim.Adam(self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aa9b70ab17914958358dd95948b30eb3c}{model}}.parameters(),\ lr=lr)}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00016}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a83f22ae4db501627eeca40cf23a7dd31}{00016}}\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a83f22ae4db501627eeca40cf23a7dd31}{criterion}}\ =\ torch.nn.MSELoss()}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{train_8py_source_l00018}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a34ba972c67586631289ebf2a8a0f8d5d}{00018}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a34ba972c67586631289ebf2a8a0f8d5d}{get\_dataloader}}(self):}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00019}00019\ \ \ \ \ \ \ \ \ transform\ =\ transforms.Compose([transforms.Resize(tuple(self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ab9bfe46d0164b13fa4c1fe01df98936f}{cfg}}[\textcolor{stringliteral}{"{}vqvae"{}}][\textcolor{stringliteral}{"{}image\_size"{}}])),\ transforms.ToTensor()])}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00020}00020\ \ \ \ \ \ \ \ \ dataset\ =\ datasets.ImageFolder(root=self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ab9bfe46d0164b13fa4c1fe01df98936f}{cfg}}[\textcolor{stringliteral}{"{}dataset\_dir"{}}],\ transform=transform)}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00021}00021\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ DataLoader(dataset,\ batch\_size=self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ab9bfe46d0164b13fa4c1fe01df98936f}{cfg}}[\textcolor{stringliteral}{"{}vqvae"{}}][\textcolor{stringliteral}{"{}batch\_size"{}}],\ shuffle=\textcolor{keyword}{True},\ num\_workers=self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ab9bfe46d0164b13fa4c1fe01df98936f}{cfg}}[\textcolor{stringliteral}{"{}vqvae"{}}][\textcolor{stringliteral}{"{}num\_workers"{}}])}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{train_8py_source_l00023}\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a915f9c6f16da6bd5c87ecb74627c34cc}{00023}}\ \ \ \ \ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespacetrain}{train}}(self):}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00024}00024\ \ \ \ \ \ \ \ \ dataloader\ =\ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a34ba972c67586631289ebf2a8a0f8d5d}{get\_dataloader}}()}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00025}00025\ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aa9b70ab17914958358dd95948b30eb3c}{model}}.\mbox{\hyperlink{namespacetrain}{train}}()}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00026}00026\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ epoch\ \textcolor{keywordflow}{in}\ range(self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ab9bfe46d0164b13fa4c1fe01df98936f}{cfg}}[\textcolor{stringliteral}{"{}vqvae"{}}][\textcolor{stringliteral}{"{}num\_epochs"{}}]):}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00027}00027\ \ \ \ \ \ \ \ \ \ \ \ \ running\_loss\ =\ 0}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00028}00028\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ imgs,\ \_\ \textcolor{keywordflow}{in}\ dataloader:}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00029}00029\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ imgs\ =\ imgs.to(self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aae385d47fb914216902363ee452d30db}{device}})}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00030}00030\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ recon,\ vq\_loss,\ \_\ =\ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aa9b70ab17914958358dd95948b30eb3c}{model}}(imgs)}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00031}00031\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ recon\_loss\ =\ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a83f22ae4db501627eeca40cf23a7dd31}{criterion}}(recon,\ imgs)}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00032}00032\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ loss\ =\ recon\_loss\ +\ vq\_loss}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00033}00033\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a2027952a103bbc6f53d22f443a1d381c}{optimizer}}.zero\_grad()}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ loss.backward()}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00035}00035\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_a2027952a103bbc6f53d22f443a1d381c}{optimizer}}.step()}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00036}00036\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ running\_loss\ +=\ loss.item()}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00037}00037\ \ \ \ \ \ \ \ \ \ \ \ \ avg\_loss\ =\ running\_loss\ /\ len(dataloader)}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00038}00038\ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ae0b075546c18498b87aa092e22a0ed3b}{logger}}.info(f\textcolor{stringliteral}{"{}Epoch\ \{epoch+1\}/\{self.cfg['vqvae']['num\_epochs']\}:\ Loss=\{avg\_loss:.4f\}"{}})}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00039}00039\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (epoch\ +\ 1)\ \%\ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ab9bfe46d0164b13fa4c1fe01df98936f}{cfg}}[\textcolor{stringliteral}{"{}vqvae"{}}][\textcolor{stringliteral}{"{}save\_interval"{}}]\ ==\ 0:}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00040}00040\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ckpt\_path\ =\ f\textcolor{stringliteral}{"{}\{self.cfg['vqvae']['checkpoint\_dir']\}/vqvae\_\{epoch+1\}.pth"{}}}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00041}00041\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ torch.save(self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_aa9b70ab17914958358dd95948b30eb3c}{model}}.state\_dict(),\ ckpt\_path)}
\DoxyCodeLine{\Hypertarget{train_8py_source_l00042}00042\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\mbox{\hyperlink{classtrain_1_1_v_q_v_a_e_trainer_ae0b075546c18498b87aa092e22a0ed3b}{logger}}.info(f\textcolor{stringliteral}{"{}Saved\ checkpoint:\ \{ckpt\_path\}"{}})}

\end{DoxyCode}
